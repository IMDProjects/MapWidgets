<html>

<head>
    <link rel="stylesheet" href="appStyles.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
    <script type="text/javascript" src="https://js.arcgis.com/3.16/"></script>
    <script src="https://code.highcharts.com/adapters/standalone-framework.js"></script>
    <script type="text/javascript" src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="dataReviewHelper.js"></script>
    <script src="configDataReview.js"></script>
    <script src="getData.js"></script>
    <script src="Size_over_Time_Function.js"></script>
    <script src="BasicScatterplot.js"></script>
    <script>
          $( function() {
            $( "#tabs" ).tabs();
          } );
    </script>
    <script>
        /**
         * Helper functions for NPS MEDN Kelp Forest Story Map.
         * 
         * Created by:  NPS Inventory and Monitoring Division GIS Staff
         * Credits: 
        */
        // Global variables
        var whereList = []; //siteNames
        var whatList = []; //kfmSpecies
        var surveyYears = [];
        var selSpeciesValue = "";
        var selSiteValue = "";
        var setYearValue = "";
        var targetURL = "https://services1.arcgis.com/fBc8EJBxQRMcHlei/ArcGIS/rest/services/GDB_KFM_20161102_gdb/FeatureServer";
		// Original
        //var targetURL = "https://services1.arcgis.com/fBc8EJBxQRMcHlei/arcgis/rest/services/GDB_MEDN_PyriferaMarineMap_gdb/FeatureServer";
        var querySet = {};  // global object for data query
        
        require(["esri/IdentityManager", "esri/ServerInfo", "esri/Credential", "esri/request", "esri/tasks/query", "esri/tasks/QueryTask", "esri/tasks/StatisticDefinition", "esri/layers/FeatureLayer", "dojo/dom"], function (idManager, ServerInfo, Credential, esriRequest, Query, QueryTask, StatisticDefinition, FeatureLayer, dom) {

            var token = "";
            var whatItems = [];
            
            
            /* Set token for session
             *   Can be removed when feature layer and web map are made public
             */
            var token = getConfig();
            /*var token = getConfig().then(function(token) {
                alert(token);
            });*/
            
            /*
             * Initialize selection list by querying the PyriferaMarineMap table.
             *  Re-factor to cache these records since there are >460000 of them!
             */
            initializeSelections("1=1", true);
            /*var query = new Query();
            query.where = "1=1";
            query.outFields = ["SiteName", "SpeciesName", "Year"];
            query.returnDistinctValues = true;   */               
            
            /* Handle the query response, populating the where (site/island) and 
             *   what (species/year) select lists.
             */
            function queryTaskCompleteHandler(queryResults) {
                console.log("complete", queryResults);
                var items = dojo.map(queryResults.features, function (item) {
                    return {  
                        name: item.attributes.SiteName
                    };
                }); 
                
                /*var sYears = dojo.map(queryResults.features, function (item) {
                    return {  
                        name: item.attributes.Year
                    };  
                });*/

                for (i=0; i<items.length; i++) {
                    if(whereList.indexOf(items[i].name) === -1) {
                        whereList.push(items[i].name);
                    } 
                }  
                whereList.sort();
                //alert(siteNames);
                
               /* for (i=0; i<sYears.length; i++) {
                    if(surveyYears.indexOf(sYears[i].name) === -1) {
                        surveyYears.push(sYears[i].name);
                    } 
                }  
                surveyYears.sort();
                surveyYears.forEach(function(item) {
                    yOption = document.createElement("option");
                    yOption.text = item;
                    yOption.value = item;
                    document.getElementById("year-select").appendChild(yOption); 
                    }
                )
                dom.byId("year-select").addEventListener("change", getGraphData, false);*/
                
                whatList = dojo.map(queryResults.features, function (item) {  
                    return {  
                        name: item.attributes.SpeciesName, 
                        id: item.attributes.SiteName
                    };  
                });
                
                for (i=0; i<whatList.length; i++) { 
                    if (whatItems.indexOf(whatList[i].name) === -1) {
                        whatItems.push(whatList[i].name);
                    }
                }
                
                whatList.sort();
                updateSiteList();
            }

            /* Handle query response errors */
            function queryTaskErrorHandler(queryError){
                alert("ERROR:\n" + queryError.error.details);
                console.log("error", queryError.error.details);
            }   
            
            /*  Configure the where (site/island) select list. */
            function updateSiteList() {
                dom.byId("site-select").addEventListener("change", getSpecies, false);
                dom.byId("species-select").addEventListener("change", makeChart, false);
                dom.byId("species-select").addEventListener("onkeyup", makeChart, false);
                whereList.forEach(function(item) {
                    siteOption = document.createElement("option");
                    siteOption.text = item;
                    siteOption.value = item;
                    dom.byId("site-select").appendChild(siteOption); 
                }
                )
            }    
            
            /* Get sites, islands, species, years from PyriferaMarineMap table (7) in GDB_MEDN_PyriferaMarineMap_gdb */
            tempLayer = new FeatureLayer(targetURL + "/7",{});
            tempLayer.queryFeatures(querySet.query, queryTaskCompleteHandler, queryTaskErrorHandler);
        });

        /* Configure the what (species, years) select list. */
        function getSpecies() {
            //alert("Selected a site");
            selSiteValue = this.value;
            
            var spList = [];
            spList0 = whatList.filter(function (item) {return item.id === selSiteValue});
            for (i=0; i<spList0.length; i++) { if (spList.indexOf(spList0[i].name) === -1) {spList.push(spList0[i].name);}}
            
            while (document.getElementById("species-select").length > 0) {
                document.getElementById("species-select").remove(0);
            }
            spList.sort();
            spList.forEach(function(item) {
                    spOption = document.createElement("option");
                    spOption.text = item;
                    spOption.value = item;
                    document.getElementById("species-select").appendChild(spOption); 
                }
            )
        }
        
        /* Initiate graph rendering. */
        function makeChart() {
            selSpeciesValue = this.value;
            getGraphData();
        }
        
    
    </script>
</head>

<body class="tundra">
    <div id="tabs">
        <ul>
            <li><a href="#tabs-1">Site &amp; Species</a>
            </li>
            <li><a href="#tabs-2">Site &amp; Year</a>
            </li>
            <li><a href="#tabs-3">Island &amp; Species</a>
            </li>
            <li><a href="#tabs-4">Island &amp; Year</a>
            </li>
        </ul>
        <div id="tabs-1" class="ui-button.ui-state-activecustom">
            <div id="sites" class="styled-select green rounded">
                <select id="site-select">
                    <option>Select a site:</option>
                </select>
            </div>
            <div id="species" class="styled-select green rounded">
                <select id="species-select">
                    <option>Select a species for the site:</option>
                </select>
            </div>
            <div class="charts">
                <div id="box">
                    <div id="chartSiteSpecies1">1m Quadrat</div>
                </div>
                <div id="box">
                    <div id="chartSiteSpecies2">5m Quadrat</div>
                </div>
                <div id="box">
                    <div id="chartSiteSpecies3">Band Transect</div>
                </div>
                <div id ="box">
                    <div id="chartSiteSpecies4">RPC</div>
                </div>
            </div>
        </div>
        <div id="tabs-2">
            <div id="sites" class="styled-select green rounded">
                <select id="site-select2">
                    <option>Select a site:</option>
                </select>
            </div>
            <div id="years" class="styled-select green rounded">
                <select id="year-select">
                    <option>Select a year:</option>
                </select>
            </div>
            <div id="chartSiteYear"></div>
        </div>
        <div id="tabs-3">
            <div id="sites" class="styled-select green rounded">
                <select id="island-select">
                    <option>Select an island:</option>
                </select>
            </div>
            <div id="species" class="styled-select green rounded">
                <select id="species-select2">
                    <option>Select a species for the island:</option>
                </select>
            </div>
            <div id="chartIslandSpecies"></div>
        </div>
        <div id="tabs-4">
            <div id="sites" class="styled-select green rounded">
                <select id="island-select2">
                    <option>Select an island:</option>
                </select>
            </div>
            <div id="years" class="styled-select green rounded">
                <select id="year-select2">
                    <option>Select a year:</option>
                </select>
            </div>
            <div id="chartIslandYear"></div>

        <div id="chart"></div>
        <div id="chart2"></div>
        <div id="chart3"></div>
    </div>
</body>

</html>